(function(){var $,attachFile,attachLink,attachYoutube,createFileFields,createLinkFields,createYoutubeFields,nameGenerator,render,renderAttachment,renderString,selectFile;$=jQuery;selectFile=function(onSelect,options){var frame;if(frame){frame.open();return}frame=wp.media({title:options.title||"Select file",button:{text:"Select"},library:{type:options.type},multiple:options.multiple});frame.on("open",function(){var selection;selection=frame.state().get("selection")});frame.on("select",function(){var selected;selected=frame.state().get("selection").map(function(model){return model.toJSON()});if(typeof onSelect==="function"){onSelect(selected)}});return frame.open()};renderAttachment=function(type,data){var el,li;li=$('<li class="wppa-link" />');li.appendTo("#wpPostAttachments-list");li.append(el=render(type,data));return typeof console!=="undefined"&&console!==null?console.log("trigger insert",el):void 0};createLinkFields=function(){return renderAttachment("link")};createFileFields=function(type,file){if(typeof console!=="undefined"&&console!==null){console.log(type,file)}return renderAttachment(type!=null?type:"file",{file:file,file_id:file.id,title:file.title,description:file.description})};createYoutubeFields=function(){return renderAttachment("youtube")};attachFile=function(type){return selectFile(function(selected){return _.each(selected,function(file){return createFileFields(type,file)})},{type:type,multiple:true})};attachYoutube=function(){var el,loadDefaultThumb,model;if(typeof console!=="undefined"&&console!==null){console.log("attachYoutube")}el=createYoutubeFields();model=el.find('[data-model="video_id"]');loadDefaultThumb=function(){var i;if(typeof console!=="undefined"&&console!==null){console.log("loadDefaultThumb",model.val())}el.find("img.default-thumb").remove();i=new Image;i.onload=function(){var img;img=$('<img class="default-thumb" />');img.attr("src",this.src);img.prependTo(el);this.onload=null};i.src="http://img.youtube.com/vi/"+model.val()+"/default.jpg"};model.change(loadDefaultThumb);loadDefaultThumb();return el};attachLink=function(){return createLinkFields()};nameGenerator={_counter:0,name:function(n){return"post_attachments["+this._counter+"]["+n+"]"},next:function(){return++this._counter}};render=function(name,data){var el,template;nameGenerator.next();template=wp.template("wpPostAttachments-"+name);data=$.extend({$:$,jQuery:$,render:render,renderString:renderString},data);el=$(template(data));el.find("[name]").each(function(){var $this;$this=$(this);return $this.attr("name",nameGenerator.name($this.attr("name")))});return el};renderString=function(name,data){return $("<div/>").append(render(name,data)).html()};$(function(){var template;template=wp.template("wpPostAttachments-main");$("#post-attachments-metabox").html(template({render:render,renderString:renderString}));if(typeof console!=="undefined"&&console!==null){console.log(window.postAttachments)}_.each(window.postAttachments,function(attachment){return renderAttachment(attachment.type,attachment)});$("#post-attachments-metabox").on("click",'[data-action="attach-link"]',function(){attachLink();return false}).on("click",'[data-action="attach-file"]',function(){attachFile();return false}).on("click",'[data-action="attach-audio"]',function(){attachFile("audio");return false}).on("click",'[data-action="attach-youtube"]',function(){attachYoutube();return false}).on("click",'[data-action="attachment-delete"]',function(){var li,li2,tpl;li=$(this).closest("li");li2=$('<li class="wppa-link" />');tpl=wp.template("wpPostAttachments-undo");li2.append(tpl());li2.outerWidth(li.outerWidth());li2.outerHeight(li.outerHeight());li.replaceWith(li2);li2.data("origLI",li);return false}).on("click",'[data-action="delete-undo"]',function(){var li;li=$(this).closest("li");li.replaceWith(li.data("origLI"));li.remove();return false}).on("click",'[data-action="delete-confirm"]',function(){var li;li=$(this).closest("li");li.animate({outerHeight:0,opacity:0},function(){return $(this).remove()});return false});$("#wpPostAttachments-list").sortable()});this.selectFile=selectFile;this.wpPostAttachments={render:render}}).call(this);